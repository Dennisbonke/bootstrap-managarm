sources:
  - name: wine
    subdir: 'ports'
    git: 'https://source.winehq.org/git/wine.git'
    tag: 'wine-7.1'
    version: '7.1'
    disable_shallow_fetch: true
    tools_required:
      - host-automake-v1.15
    regenerate:
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.15/share/automake-1.15/config.sub',
          '@THIS_SOURCE_DIR@/tools/']

tools:
  - name: host-wine-tools
    from_source: wine
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
        - '--enable-win64'
        - '--disable-tests'
        - '--disable-win16'
        - '--without-alsa'
        - '--without-capi'
        - '--without-cups'
        - '--without-dbus'
        - '--without-gettext'
        - '--without-gphoto'
        - '--without-gssapi'
        - '--without-gstreamer'
        - '--without-krb5'
        - '--without-ldap'
        - '--without-mingw'
        - '--without-netapi'
        - '--without-openal'
        - '--without-opencl'
        - '--without-osmesa'
        - '--without-oss'
        - '--without-pcap'
        - '--without-pulse'
        - '--without-sane'
        - '--without-sdl'
        - '--without-unwind'
        - '--without-usb'
        - '--without-v4l2'
        - '--without-vkd3d'
        - '--without-vulkan'
        - '--without-xcomposite'
        - '--without-xinerama'
        - '--without-xinput2'
        - '--without-xshape'
        - '--without-xcursor'
        - '--without-xinput'
        - '--without-xfixes'
        - '--without-xrandr'
        - '--without-xrender'
        - '--without-xshape'
        - '--without-xxf86vm'
        - '--without-xshm'
        - '--without-gnutls'
        - '--without-opengl'
        - '--without-udev'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install']

packages:
  - name: qemu
    architecture: '@OPTION:arch@'
    metadata:
      summary: A generic and open source machine emulator and virtualizer
      description: A generic and open source machine emulator and virtualizer
      spdx: 'GPL-2.0'
      website: 'https://qemu.org/'
      maintainer: 'Kacper Słomiński <qookie@managarm.org>'
      categories: ['app-emulation']
    source:
      subdir: 'ports'
      git: 'https://github.com/qemu/qemu.git'
      tag: 'v6.2.0'
      version: '6.2.0'
    revision: 2
    tools_required:
      - host-pkg-config
      - system-gcc
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
    pkgs_required:
      - mlibc
      - glib
      - sdl2
      - pcre
      - libiconv
      - libxml
      - zstd
      - libpng
      - pixman
      - ncurses
      - nettle
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--cross-prefix=@OPTION:arch-triple@-'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--target-list=i386-softmmu,x86_64-softmmu,aarch64-softmmu,riscv32-softmmu,riscv64-softmmu'
        - '--disable-slirp'
        - '--with-coroutine=sigaltstack'
        environ:
          PKG_CONFIG_LIBDIR: '@SYSROOT_DIR@/usr/lib/pkgconfig:@SYSROOT_DIR@/usr/share/pkgconfig'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: wine
    architecture: '@OPTION:arch@'
    metadata:
      maintainer: 'Dennis Bonke <dennis@managarm.org>'
      categories: ['app-emulation']
    from_source: wine
    tools_required:
      - host-pkg-config
      - system-gcc
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
      - host-wine-tools
    pkgs_required:
      - mlibc
      - fontconfig
      - freetype
      - gnutls
      - mesa
      - eudev
      - libxi
      - libxfixes
      - libxrender
      - libxrandr
      - libxshmfence
      - libxxf86vm
      - libjpeg-turbo
      - libpng
      - libxml
      - libxslt
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-tests'
        - '--enable-win64' # We want 64 bit after all
        - '--disable-win16' # Don't care about 16 bit
        - '--without-alsa'
        - '--without-capi'
        - '--without-cups'
        - '--without-dbus'
        - '--without-gettext'
        - '--without-gphoto'
        - '--without-gssapi'
        - '--without-gstreamer'
        # - '--without-inotify'
        - '--without-krb5'
        - '--without-ldap'
        - '--without-mingw' # Might want this later, but for now we don't have it
        - '--without-netapi'
        - '--without-openal'
        - '--without-opencl'
        - '--without-osmesa'
        - '--without-oss'
        - '--without-pcap'
        - '--without-pulse'
        - '--without-sane'
        - '--without-sdl' # Needs additional patching in wine
        - '--without-unwind'
        - '--without-usb'
        - '--without-v4l2'
        - '--without-vkd3d'
        - '--without-vulkan'
        - '--without-xcomposite'
        - '--without-xinerama'
        - '--with-x'
        - '--with-wine-tools=@BUILD_ROOT@/tool-builds/host-wine-tools/'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true
